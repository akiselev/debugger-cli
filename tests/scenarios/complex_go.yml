# Complex Go Variable Verification Test
# Tests local variable inspection, stepping into functions, and expression evaluation
#
# NOTE: Delve uses TCP-based DAP connections rather than stdin/stdout.
# This test requires TCP-based DAP adapter support to be implemented.
# Currently expected to fail until that feature is added.

name: "Go Complex Variable Verification"
description: "Verifies Go debugging with Delve: variables, types, stepping, and expressions"

# Compile the test program with debug info (disable optimizations and inlining)
setup:
  - shell: "go build -gcflags='all=-N -l' -o tests/fixtures/test_simple_go tests/fixtures/simple.go"

# Debug target configuration
target:
  program: "../fixtures/test_simple_go"
  args: []
  adapter: "go"
  stop_on_entry: true

# Test steps
steps:
  # 1. Set a breakpoint at main.main
  - action: command
    command: "break main.main"
    expect:
      success: true

  # 2. Set a breakpoint in the add function
  - action: command
    command: "break main.add"
    expect:
      success: true

  # 3. Continue to main
  - action: command
    command: "continue"

  - action: await
    timeout: 10
    expect:
      reason: "breakpoint"
      file: "simple.go"

  # 4. Step to initialize x
  - action: command
    command: "next"

  - action: await
    timeout: 10
    expect:
      reason: "step"

  # 5. Step to initialize y  
  - action: command
    command: "next"

  - action: await
    timeout: 10
    expect:
      reason: "step"

  # 6. Step past y initialization to make it visible
  - action: command
    command: "next"

  - action: await
    timeout: 10
    expect:
      reason: "step"

  # 7. Check local variables x and y
  - action: inspect_locals
    asserts:
      - name: "x"
        value_contains: "10"
      - name: "y"
        value_contains: "20"

  # 8. Continue to add function breakpoint
  - action: command
    command: "continue"

  - action: await
    timeout: 10
    expect:
      reason: "breakpoint"

  # 9. Check function arguments in add
  - action: inspect_locals
    asserts:
      - name: "a"
        value_contains: "10"
      - name: "b"
        value_contains: "20"

  # 10. Check the stack trace
  - action: inspect_stack
    asserts:
      - index: 0
        function: "main.add"
      - index: 1
        function: "main.main"

  # 11. Step to compute result
  - action: command
    command: "next"

  - action: await
    timeout: 10
    expect:
      reason: "step"

  # 12. Step past result assignment to make it visible
  - action: command
    command: "next"

  - action: await
    timeout: 10
    expect:
      reason: "step"

  # 13. Verify result variable
  - action: inspect_locals
    asserts:
      - name: "result"
        value_contains: "30"

  # 14. Evaluate an expression
  - action: evaluate
    expression: "a * b"
    expect:
      result_contains: "200"

  # 15. Continue to exit (Delve sends "terminated" event)
  - action: command
    command: "continue"

  - action: await
    timeout: 15
    expect:
      reason: "terminated"
